dist: bionic
language: go

services:
  - docker

go:
  - 1.11.x
  - 1.12.x
  - 1.13.x
  - master

matrix:
  allow_failures:
    - go: master

go_import_path: gopkg.in/reform.v1

before_cache:
  - go clean -testcache

cache:
  directories:
    - /home/travis/.cache/go-build
    - /home/travis/gopath/pkg/mod

env:
  global:
    - GO111MODULE=on
    - GOPROXY=https://proxy.golang.org
    - GOFLAGS="-mod=readonly"
    - GORACE="halt_on_error=1"
    - REFORM_MSSQL_IMAGE=microsoft/mssql-server-linux:latest

  matrix:
    - REFORM_POSTGRES_IMAGE=postgres:9.6 REFORM_MYSQL_IMAGE=mysql:5.5
    - REFORM_POSTGRES_IMAGE=postgres:10  REFORM_MYSQL_IMAGE=mysql:5.6
    - REFORM_POSTGRES_IMAGE=postgres:11  REFORM_MYSQL_IMAGE=mysql:5.7
    - REFORM_POSTGRES_IMAGE=postgres:12  REFORM_MYSQL_IMAGE=mysql:8.0

before_install:
  - docker --version
  - docker-compose --version

  - docker-compose pull
  - docker-compose up --detach

install:
  # check that it is still possible to install everything without modules
  - env GO111MODULE=off go get -v ./...
  - reform -version
  - reform-db -version

  - go mod download

  - make init

script:
  - make test

  # TODO test again with updated deps

  - git status
  - git diff --exit-code

after_success:
  - bash <(curl -s https://codecov.io/bash) -f coverage.txt -X fix -e REFORM_POSTGRES_IMAGE,REFORM_MYSQL_IMAGE,REFORM_MSSQL_IMAGE

notifications:
  webhooks:
    urls:
      # Gitter
      - secure: "M5FL6dahsnY6TsU03QptqRoVriulkFPGLoKmbwLWAmPTk+h6SreMKIJHTmSba77snYVWR/gMLMNW01yMBrbV+ZmVgU6Sdp6yYlciA4cQcvIM7pwKuIfzeKhMCE2oeNVB3G2IHeu+FysbFXzI1JV9oU1I453aksyAPi4flf8eVUeMUa3nxWQt84MFC5RFn/pJ0G8lwUgAmHq56FjiOZ+5hF224s++CEEGGSclGZLH0/+T7SVH9sWSpyBuFtB6LZsl78JQ3mdxpFe95VAlpaB/PWdi7BXnZQ8XHgG1U1+1Z5at1uEmMmYjsQ5GzxaTEfjBRdC5AT6bRHjhW5wpI0tFKX77+1eexQXypuKyGIax7/7wFhKoEsU/9IUneqm17H9C5ZecF0xfvgTT4e2sHihm4qmYhQOFhGW+zlZdkp6rKzT17H0+g2q0IH3MJOKghyMO8l/YDy+wt2jdHggobfZLgcWLhyaHkUy0570jVUc+s+Zk/OOHr8kExvUcBuQeE38sQD6KEQoeeevXNlNtwrHvafjTfH1cUrc5JwFzP7go3VBEYxaHu+ctO7+DcUswOUsnTRiTQrp2FgNQP0TdlGgHgFV9cN5C+VcCwiB4NuU4ZM6J2TYmR6Wih4h/NooFKa8DiD++mqdyf6PhBn3tfHHtBFaLuE2GYMJ61MAv4kMNcBk="
